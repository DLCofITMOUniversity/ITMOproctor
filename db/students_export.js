var config = require('nconf').file('../config.json');
var mongoose = require('mongoose');
var config = require('nconf');
var path = require('path');
var moment = require('moment');

if (process.argv.length !== 2) {
    process.exit(1);
}

mongoose.connect(config.get('mongoose:uri'));
var conn = mongoose.connection;
conn.on('error', function(err) {
    console.error("MongoDB connection error:", err.message);
});
conn.once('open', function() {
    console.info("MongoDB is connected.");
    db.go(function() {
        mongoose.disconnect();
        console.log('done');
        process.exit(0);
    });
});

var db = {
    go: function(callback) {
        var self = this;
        var User = require('./models/user');
        var copyObj = function(obj) {
            return JSON.parse(JSON.stringify(obj));
        };
        User.find({
            created: {
                '$lt': moment("2017-08-31T00:00:00.000Z")
            }
        }).sort("lastname").exec(function(err, data) {
            if (err || !data) return;
            var students = [];
            data.forEach(function(elem, i, arr) {
                students.push({
                    username: "" + elem.username,
                    lastname: "" + elem.lastname,
                    firstname: "" + elem.firstname,
                    middlename: elem.middlename == null || elem.middlename == undefined ? "" : "" + elem.middlename,
                    email: "" + elem.email,
                    birthday: "" + elem.birthday,
                    citizenship: elem.citizenship == null || elem.citizenship == undefined ? "" : "" + countries[""+elem.citizenship],
                    created: "" + moment(elem.created).format("DD.MM.YYYY")
                });
            });
            console.log(students);
        });        
    }
};

var countries = {
    "null": "Не выбрано",
    "ABH": "Абхазия",
    "AUS": "Австралия",
    "AUT": "Австрия",
    "AZE": "Азербайджан",
    "ALB": "Албания",
    "DZA": "Алжир",
    "ASM": "Американское Самоа",
    "AIA": "Ангилья",
    "AGO": "Ангола",
    "AND": "Андорра",
    "ATA": "Антарктида",
    "ATG": "Антигуа и Барбуда",
    "ARG": "Аргентина",
    "ARM": "Армения",
    "ABW": "Аруба",
    "AFG": "Афганистан",
    "BHS": "Багамы",
    "BGD": "Бангладеш",
    "BRB": "Барбадос",
    "BHR": "Бахрейн",
    "BLR": "Беларусь",
    "BLZ": "Белиз",
    "BEL": "Бельгия",
    "BEN": "Бенин",
    "BMU": "Бермуды",
    "BGR": "Болгария",
    "BOL": "Боливия",
    "BES": "Бонайре, Саба и Синт-Эстатиус",
    "BIH": "Босния и Герцеговина",
    "BWA": "Ботсвана",
    "BRA": "Бразилия",
    "IOT": "Британская территория в Индийском океане",
    "BRN": "Бруней-Даруссалам",
    "BFA": "Буркина-Фасо",
    "BDI": "Бурунди",
    "BTN": "Бутан",
    "VUT": "Вануату",
    "HUN": "Венгрия",
    "VEN": "Венесуэла Боливарианская Республика",
    "VGB": "Виргинские острова, Британские",
    "VIR": "Виргинские острова, США",
    "VNM": "Вьетнам",
    "GAB": "Габон",
    "HTI": "Гаити",
    "GUY": "Гайана",
    "GMB": "Гамбия",
    "GHA": "Гана",
    "GLP": "Гваделупа",
    "GTM": "Гватемала",
    "GIN": "Гвинея",
    "GNB": "Гвинея-Бисау",
    "DEU": "Германия",
    "GGY": "Гернси",
    "GIB": "Гибралтар",
    "HND": "Гондурас",
    "HKG": "Гонконг",
    "GRD": "Гренада",
    "GRL": "Гренландия",
    "GRC": "Греция",
    "GEO": "Грузия",
    "GUM": "Гуам",
    "DNK": "Дания",
    "JEY": "Джерси",
    "DJI": "Джибути",
    "DMA": "Доминика",
    "DOM": "Доминиканская Республика",
    "EGY": "Египет",
    "ZMB": "Замбия",
    "ESH": "Западная Сахара",
    "ZWE": "Зимбабве",
    "ISR": "Израиль",
    "IND": "Индия",
    "IDN": "Индонезия",
    "JOR": "Иордания",
    "IRQ": "Ирак",
    "IRN": "Иран",
    "IRL": "Ирландия",
    "ISL": "Исландия",
    "ESP": "Испания",
    "ITA": "Италия",
    "YEM": "Йемен",
    "CPV": "Кабо-Верде",
    "KAZ": "Казахстан",
    "KHM": "Камбоджа",
    "CMR": "Камерун",
    "CAN": "Канада",
    "QAT": "Катар",
    "KEN": "Кения",
    "CYP": "Кипр",
    "KGZ": "Киргизия",
    "KIR": "Кирибати",
    "CHN": "Китай",
    "CCK": "Кокосовые (Килинг) острова",
    "COL": "Колумбия",
    "COM": "Коморы",
    "COG": "Конго",
    "COD": "Демократическая Республика Конго",
    "PRK": "Корея, Народно-Демократическая Республика",
    "KOR": "Корея, Республика",
    "CRI": "Коста-Рика",
    "CIV": "Кот д'Ивуар",
    "CUB": "Куба",
    "KWT": "Кувейт",
    "CUW": "Кюрасао",
    "LAO": "Лаос",
    "LVA": "Латвия",
    "LSO": "Лесото",
    "LBN": "Ливан",
    "LBY": "Ливийская Арабская Джамахирия",
    "LBR": "Либерия",
    "LIE": "Лихтенштейн",
    "LTU": "Литва",
    "LUX": "Люксембург",
    "MUS": "Маврикий",
    "MRT": "Мавритания",
    "MDG": "Мадагаскар",
    "MYT": "Майотта",
    "MAC": "Макао",
    "MWI": "Малави",
    "MYS": "Малайзия",
    "MLI": "Мали",
    "UMI": "Малые Тихоокеанские отдаленные острова Соединенных Штатов",
    "MDV": "Мальдивы",
    "MLT": "Мальта",
    "MAR": "Марокко",
    "MTQ": "Мартиника",
    "MHL": "Маршалловы острова",
    "MEX": "Мексика",
    "FSM": "Микронезия",
    "MOZ": "Мозамбик",
    "MDA": "Молдова, Республика",
    "MCO": "Монако",
    "MNG": "Монголия",
    "MSR": "Монтсеррат",
    "MMR": "Мьянма",
    "NAM": "Намибия",
    "NRU": "Науру",
    "NPL": "Непал",
    "NER": "Нигер",
    "NGA": "Нигерия",
    "NLD": "Нидерланды",
    "NIC": "Никарагуа",
    "NIU": "Ниуэ",
    "NZL": "Новая Зеландия",
    "NCL": "Новая Каледония",
    "NOR": "Норвегия",
    "ARE": "Объединенные Арабские Эмираты",
    "OMN": "Оман",
    "BVT": "Остров Буве",
    "IMN": "Остров Мэн",
    "NFK": "Остров Норфолк",
    "CXR": "Остров Рождества",
    "HMD": "Остров Херд и острова Макдональд",
    "CYM": "Острова Кайман",
    "COK": "Острова Кука",
    "TCA": "Острова Теркс и Кайкос",
    "PAK": "Пакистан",
    "PLW": "Палау",
    "PSE": "Палестинская территория, оккупированная",
    "PAN": "Панама",
    "VAT": "Папский Престол (Государство &mdash; город Ватикан)",
    "PNG": "Папуа-Новая Гвинея",
    "PRY": "Парагвай",
    "PER": "Перу",
    "PCN": "Питкерн",
    "POL": "Польша",
    "PRT": "Португалия",
    "PRI": "Пуэрто-Рико",
    "MKD": "Республика Македония",
    "REU": "Реюньон",
    "RUS": "Россия",
    "RWA": "Руанда",
    "ROU": "Румыния",
    "WSM": "Самоа",
    "SMR": "Сан-Марино",
    "STP": "Сан-Томе и Принсипи",
    "SAU": "Саудовская Аравия",
    "SWZ": "Свазиленд",
    "SHN": "Святая Елена, Остров вознесения, Тристан-да-Кунья",
    "MNP": "Северные Марианские острова",
    "BLM": "Сен-Бартельми",
    "MAF": "Сен-Мартен",
    "SEN": "Сенегал",
    "VCT": "Сент-Винсент и Гренадины",
    "KNA": "Сент-Китс и Невис",
    "LCA": "Сент-Люсия",
    "SPM": "Сент-Пьер и Микелон",
    "SRB": "Сербия",
    "SYC": "Сейшелы",
    "SGP": "Сингапур",
    "SXM": "Синт-Мартен",
    "SYR": "Сирийская Арабская Республика",
    "SVK": "Словакия",
    "SVN": "Словения",
    "GBR": "Соединенное Королевство",
    "USA": "Соединенные Штаты",
    "SLB": "Соломоновы острова",
    "SOM": "Сомали",
    "SDN": "Судан",
    "SUR": "Суринам",
    "SLE": "Сьерра-Леоне",
    "TJK": "Таджикистан",
    "THA": "Таиланд",
    "TWN": "Тайвань (Китай)",
    "TZA": "Танзания, Объединенная Республика",
    "TLS": "Тимор-Лесте",
    "TGO": "Того",
    "TKL": "Токелау",
    "TON": "Тонга",
    "TTO": "Тринидад и Тобаго",
    "TUV": "Тувалу",
    "TUN": "Тунис",
    "TKM": "Туркмения",
    "TUR": "Турция",
    "UGA": "Уганда",
    "UZB": "Узбекистан",
    "UKR": "Украина",
    "WLF": "Уоллис и Футуна",
    "URY": "Уругвай",
    "FRO": "Фарерские острова",
    "FJI": "Фиджи",
    "PHL": "Филиппины",
    "FIN": "Финляндия",
    "FLK": "Фолклендские острова (Мальвинские)",
    "FRA": "Франция",
    "GUF": "Французская Гвиана",
    "PYF": "Французская Полинезия",
    "ATF": "Французские Южные территории",
    "HRV": "Хорватия",
    "CAF": "Центрально-Африканская Республика",
    "TCD": "Чад",
    "MNE": "Черногория",
    "CZE": "Чешская Республика",
    "CHL": "Чили",
    "CHE": "Швейцария",
    "SWE": "Швеция",
    "SJM": "Шпицберген и Ян Майен",
    "LKA": "Шри-Ланка",
    "ECU": "Эквадор",
    "GNQ": "Экваториальная Гвинея",
    "ALA": "Эландские острова",
    "SLV": "Эль-Сальвадор",
    "ERI": "Эритрея",
    "EST": "Эстония",
    "ETH": "Эфиопия",
    "ZAF": "Южная Африка",
    "SGS": "Южная Джорджия и Южные Сандвичевы острова",
    "OST": "Южная Осетия",
    "SSD": "Южный Судан",
    "JAM": "Ямайка",
    "JPN": "Япония"
};

